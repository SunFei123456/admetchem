# 用户头像功能说明

## 功能概述

用户头像字段已添加到系统中，所有新用户和现有用户都会自动获得一个默认头像。

## 默认头像

**URL**: `https://res.cloudinary.com/dazdjqzwd/image/upload/v1760685557/68d9f143293f4f17bccdbc791dcf779d_f0rcro.png`

这个默认头像会在以下情况自动使用：
- 用户注册时未提供头像
- 现有用户（应用启动时自动设置）
- 用户删除自定义头像后

## 自动数据库同步 ✨

**无需手动迁移！** 应用启动时会自动同步数据库模型。

### 工作原理

1. 启动后端应用（`python run.py`）
2. FastAPI 的 `lifespan` 事件触发
3. 自动调用 `init_db()` 函数
4. SQLAlchemy 的 `create_all()` 创建/更新表结构
5. 新字段（如 `avatar`）自动添加到数据库

### 启动日志

```bash
$ python run.py
🚀 正在启动应用...
📊 正在同步数据库模型...
✅ 数据库同步完成！
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### 验证同步

```sql
-- 连接到MySQL数据库
USE admetchem_db;

-- 查看表结构（应该能看到avatar字段）
DESC users;

-- 查看用户头像
SELECT id, username, avatar FROM users;
```

### 注意事项

⚠️ `create_all()` 只会创建**不存在**的表和字段，不会：
- 删除已存在的字段
- 修改字段类型
- 修改字段约束

如果需要复杂的数据库迁移（修改字段类型等），建议使用 Alembic。

## 功能特性

### 后端

1. **数据库字段**
   - 字段名: `avatar`
   - 类型: `VARCHAR(500)`
   - 可为空: 是
   - 默认值: 默认头像URL

2. **API支持**
   - 注册时可以提供头像URL
   - 可以通过 `PUT /api/v1/users/me` 更新头像
   - 头像URL会在所有用户响应中返回

### 前端

1. **导航栏显示**
   - 如果用户有头像：显示圆形头像图片
   - 如果没有头像：显示默认的用户图标

2. **个人中心**
   - **头像显示**: 在个人信息卡片顶部显示
   - **头像编辑**: 可以输入新的头像URL
   - **实时预览**: 输入URL后可以看到头像预览
   - **保存修改**: 点击保存按钮更新头像

## 使用示例

### 1. 注册时提供头像

```bash
POST /api/v1/users/register
Content-Type: application/json

{
  "username": "testuser",
  "email": "test@example.com",
  "password": "password123",
  "avatar": "https://example.com/my-avatar.jpg"
}
```

### 2. 更新头像

```bash
PUT /api/v1/users/me
Authorization: Bearer <token>
Content-Type: application/json

{
  "avatar": "https://example.com/new-avatar.jpg"
}
```

### 3. 清除自定义头像（恢复默认）

```bash
PUT /api/v1/users/me
Authorization: Bearer <token>
Content-Type: application/json

{
  "avatar": "https://res.cloudinary.com/dazdjqzwd/image/upload/v1760685557/68d9f143293f4f17bccdbc791dcf779d_f0rcro.png"
}
```

## 头像URL要求

1. **格式支持**: JPG、PNG、GIF、WebP等常见图片格式
2. **推荐尺寸**: 至少 200x200 像素
3. **URL要求**: 
   - 必须是公开可访问的URL
   - 建议使用HTTPS
   - 支持CDN服务（如Cloudinary、imgur等）

## 推荐的图片托管服务

- [Cloudinary](https://cloudinary.com/) - 已用于默认头像
- [Imgur](https://imgur.com/)
- [imgbb](https://imgbb.com/)
- [Gravatar](https://gravatar.com/)

## 前端显示逻辑

```vue
<!-- 导航栏头像 -->
<div v-if="currentUser?.avatar" class="w-8 h-8 rounded-full overflow-hidden">
    <img :src="currentUser.avatar" :alt="currentUser.username" />
</div>
<div v-else class="w-8 h-8 bg-blue-500 rounded-full">
    <i class="fas fa-user"></i>
</div>

<!-- 个人中心头像 -->
<div v-if="user.avatar" class="w-20 h-20 rounded-2xl overflow-hidden">
    <img :src="user.avatar" :alt="user.username" />
</div>
```

## 故障排除

### 问题1: 迁移脚本报错

**错误**: `avatar字段已存在`
**解决**: 这是正常的，说明字段已经添加过了

### 问题2: 头像不显示

**可能原因**:
1. URL不可访问（检查URL是否有效）
2. 跨域问题（确保图片服务器允许跨域访问）
3. 图片格式不支持

**解决方法**:
1. 在浏览器中直接访问头像URL，确认可以打开
2. 检查浏览器控制台是否有CORS错误
3. 使用支持的图片格式

### 问题3: 现有用户没有头像

**解决**: 重启后端应用，自动同步会处理

```bash
# 重启应用即可
python run.py
```

## 未来增强功能（可选）

- [ ] 支持头像上传（而不只是URL）
- [ ] 头像裁剪功能
- [ ] 头像压缩和优化
- [ ] Gravatar集成
- [ ] 默认头像生成器（基于用户名首字母）

## 技术细节

### 数据库字段定义

```python
avatar = Column(
    String(500), 
    nullable=True,
    default="https://res.cloudinary.com/dazdjqzwd/image/upload/v1760685557/68d9f143293f4f17bccdbc791dcf779d_f0rcro.png"
)
```

### Schema定义

```python
class UserBase(BaseModel):
    email: EmailStr
    username: str
    avatar: Optional[str] = None  # 可选头像URL
    is_active: bool = True
```

### 前端状态管理

头像信息存储在：
1. **localStorage**: `admet_user` 对象中
2. **组件state**: `currentUser.avatar`
3. **Vuex/Pinia**: （如果使用状态管理）

## 总结

- ✅ 所有用户都有默认头像
- ✅ 支持自定义头像URL
- ✅ 导航栏和个人中心都显示头像
- ✅ 可以随时修改头像
- ✅ **自动数据库同步，无需手动迁移**

直接启动应用，头像功能自动可用！🎉

